# Docker Compose optimizado para Railway manteniendo tu configuración SQL Server
version: '3.8'

services:
  # Base de datos SQL Server (mantiene tu configuración actual)
  auth-db:
    build:
      context: ./Auth-api/.dockers/sqlserver
      dockerfile: Dockerfile
    container_name: auth-database-railway
    environment:
      ACCEPT_EULA: Y
      SA_PASSWORD: ${SQL_SERVER_SA_PASSWORD:-Root123!}
      MSSQL_PID: Express
    ports:
      - "1433:1433"
    volumes:
      - auth_db_data:/var/opt/mssql
    restart: unless-stopped
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${SQL_SERVER_SA_PASSWORD:-Root123!} -Q "SELECT 1" -C || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Base de datos Pharm (separada como en tu configuración)
  pharm-db:
    build:
      context: ./Pharm-api/.dockers/sqlserver
      dockerfile: Dockerfile
    container_name: pharm-database-railway
    environment:
      ACCEPT_EULA: Y
      SA_PASSWORD: ${SQL_SERVER_SA_PASSWORD:-Root123!}
      MSSQL_PID: Express
    ports:
      - "1434:1433"
    volumes:
      - pharm_db_data:/var/opt/mssql
    restart: unless-stopped
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${SQL_SERVER_SA_PASSWORD:-Root123!} -Q "SELECT 1" -C || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Auth API
  auth-api:
    build:
      context: ./Auth-api
      dockerfile: Dockerfile
    container_name: auth-api-railway
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:$PORT
      - SQLSERVER_CONNECTION_STRING=Server=auth-db,1433;Database=AuthDB;User Id=sa;Password=${SQL_SERVER_SA_PASSWORD:-Root123!};TrustServerCertificate=true;
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ISSUER=${JWT_ISSUER}
      - JWT_AUDIENCE=${JWT_AUDIENCE}
    ports:
      - "$PORT:$PORT"
    depends_on:
      auth-db:
        condition: service_healthy
    restart: unless-stopped

  # Pharm API
  pharm-api:
    build:
      context: ./Pharm-api
      dockerfile: Dockerfile
    container_name: pharm-api-railway
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:$PORT
      - SQLSERVER_CONNECTION_STRING=Server=pharm-db,1433;Database=PharmDB;User Id=sa;Password=${SQL_SERVER_SA_PASSWORD:-Root123!};TrustServerCertificate=true;
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ISSUER=${JWT_ISSUER}
      - JWT_AUDIENCE=${JWT_AUDIENCE}
      - AUTH_API_URL=${AUTH_API_URL}
    ports:
      - "$PORT:$PORT"
    depends_on:
      pharm-db:
        condition: service_healthy
      auth-api:
        condition: service_started
    restart: unless-stopped

volumes:
  auth_db_data:
    driver: local
  pharm_db_data:
    driver: local